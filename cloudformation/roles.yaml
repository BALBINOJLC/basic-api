AWSTemplateFormatVersion: 2010-09-09

Parameters:
    ThumbprintList:
        Type: String

    GithubRepoName:
        Type: String

Resources:
    WebappDeploymentBucket:
        Type: AWS::S3::Bucket
        Properties:
            PublicAccessBlockConfiguration:
                BlockPublicAcls: true
                BlockPublicPolicy: true
                IgnorePublicAcls: true
                RestrictPublicBuckets: true

    WebappRole:
        Type: AWS::IAM::Role
        Properties:
            Path: '/'
            RoleName: WebappRole
            AssumeRolePolicyDocument:
                Version: '2012-10-17'
                Statement:
                    - Effect: 'Allow'
                      Principal:
                          Service:
                              - 'ec2.amazonaws.com'
                              - 'codedeploy.amazonaws.com'
                      Action:
                          - 'sts:AssumeRole'
            ManagedPolicyArns:
                - 'arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore'
                - 'arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole'
            Policies:
                - PolicyName: 'allow-webapp-deployment-bucket-policy'
                  PolicyDocument:
                      Version: '2012-10-17'
                      Statement:
                          - Effect: 'Allow'
                            Action:
                                - 's3:getObject'
                                - 's3:Get*'
                                - 's3:List*'
                            Resource: !Sub arn:${AWS::Partition}:s3:::${WebappDeploymentBucket}/*

    IDCProvider:
        Type: AWS::IAM::OIDCProvider
        Properties:
            Url: 'https://token.actions.githubusercontent.com'
            ClientIdList:
                - 'sts.amazonaws.com'
            ThumbprintList:
                - !Ref ThumbprintList

    GitHubIAMRole:
        Type: AWS::IAM::Role
        Properties:
            Path: '/'
            RoleName: CodeDeployRoleforGitHub
            AssumeRolePolicyDocument:
                Statement:
                    - Effect: Allow
                      Action: sts:AssumeRoleWithWebIdentity
                      Principal:
                          Federated: !Ref IDCProvider
                      Condition:
                          StringLike:
                              token.actions.githubusercontent.com:sub: !Sub repo:${GithubRepoName}:*
            MaxSessionDuration: 3600
            Description: 'Github Actions role'
            Policies:
                - PolicyName: 'CodeDeployRoleforGitHub-policy'
                  PolicyDocument:
                      Version: '2012-10-17'
                      Statement:
                          - Effect: Allow
                            Action:
                                - 'codedeploy:Get*'
                                - 'codedeploy:Batch*'
                                - 'codedeploy:CreateDeployment'
                                - 'codedeploy:RegisterApplicationRevision'
                                - 'codedeploy:List*'
                            Resource:
                                - !Sub 'arn:${AWS::Partition}:codedeploy:*:${AWS::AccountId}:*'
                          - Effect: Allow
                            Action:
                                - 's3:putObject'
                            Resource: !Sub arn:${AWS::Partition}:s3:::${WebappDeploymentBucket}/*

    CodeDeployRole:
        Type: AWS::IAM::Role
        Properties:
            AssumeRolePolicyDocument:
                Version: '2012-10-17'
                Statement:
                    - Effect: 'Allow'
                      Principal:
                          Service:
                              - 'codedeploy.amazonaws.com'
                              - 'transfer.amazonaws.com'
                              - 'ec2.amazonaws.com'
                      Action:
                          - 'sts:AssumeRole'
            Path: '/'
            ManagedPolicyArns:
                - arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole
                - arn:aws:iam::aws:policy/AmazonEC2FullAccess
                - arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforAWSCodeDeploy
                - arn:aws:iam::aws:policy/AmazonS3FullAccess
                - arn:aws:iam::aws:policy/AWSCodeDeployFullAccess
            Policies:
                - PolicyName: allow-autoscaling
                  PolicyDocument:
                      Version: '2012-10-17'
                      Statement:
                          - Effect: Allow
                            Action:
                                - ec2:RunInstances
                                - ec2:CreateTags
                                - iam:PassRole
                            Resource:
                                - !Sub 'arn:${AWS::Partition}:codedeploy:*:${AWS::AccountId}:*'

Outputs:
    DeploymentBucket:
        Description: Deployment bucket
        Value: !Ref WebappDeploymentBucket

    GithubIAMRoleArn:
        Description: IAM role for GitHub
        Value: !GetAtt GitHubIAMRole.Arn
        Export:
            Name: GithubIAMRoleArn

    WebappRoleArn:
        Description: IAM role for Webapp
        Value: !GetAtt WebappRole.Arn
        Export:
            Name: WebappRoleArn

    CodeDeployRoleArn:
        Description: IAM role for Webapp
        Value: !GetAtt CodeDeployRole.Arn
        Export:
            Name: CodeDeployRoleArn
